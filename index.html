<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Suivi Construction Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<style>
/* ===== Reset & fonts ===== */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body,html{height:100%;overflow-x:hidden;}

/* ===== Slider fond d'écran ===== */
.slider{
    position:fixed;
    top:0;left:0;width:100%;height:100%;z-index:-1;
    overflow:hidden;
}
.slide{
    position:absolute;width:100%;height:100%;
    background-size:cover;
    background-position:center;
    animation:fade 18s infinite;
    opacity:0;
    transform:scale(1.1);
    transition:opacity 1s ease-in-out, transform 18s ease-in-out;
}
.slide:nth-child(1){background-image:url('https://images.unsplash.com/photo-1598050379713-3e72b6cb06fa?auto=format&fit=crop&w=1470&q=80');animation-delay:0s;}
.slide:nth-child(2){background-image:url('https://images.unsplash.com/photo-1600585154340-be6161a56a0c?auto=format&fit=crop&w=1470&q=80');animation-delay:6s;}
.slide:nth-child(3){background-image:url('https://images.unsplash.com/photo-1570129477492-45c003edd2be?auto=format&fit=crop&w=1470&q=80');animation-delay:12s;}
@keyframes fade{
    0%{opacity:0;transform:scale(1.1);}
    5%{opacity:1;transform:scale(1);}
    30%{opacity:1;transform:scale(1);}
    35%{opacity:0;transform:scale(1.1);}
    100%{opacity:0;}
}

/* ===== Connexion ===== */
.login-container{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    background:rgba(255,255,255,0.95);padding:40px;border-radius:12px;
    box-shadow:0 8px 25px rgba(0,0,0,0.3);width:320px;text-align:center;
}
.login-container h1{margin-bottom:20px;color:#007BFF;}
.login-container input{
    width:100%;padding:12px;margin:10px 0;border-radius:8px;border:1px solid #ccc;
}
.login-container button{
    width:100%;padding:12px;margin-top:15px;border:none;border-radius:8px;
    background:linear-gradient(90deg,#007BFF,#00CFFF);color:#fff;font-weight:600;
    cursor:pointer;transition:0.3s;
}
.login-container button:hover{transform:scale(1.03);}

/* ===== Dashboard ===== */
.dashboard{display:none;padding:20px;}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.header h2{color:#007BFF;}
.header button{padding:10px 15px;border:none;border-radius:8px;background:red;color:#fff;cursor:pointer;margin-left:5px;}
.projects-list, .expenses-list{margin-top:20px;}
.project-card{background:#fff;padding:15px;margin-bottom:10px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1);display:flex;justify-content:space-between;align-items:center;}
.project-card button{padding:6px 10px;border:none;border-radius:6px;background:#007BFF;color:#fff;margin-left:5px;cursor:pointer;}
.project-card button.delete{background:red;}
.add-project-container, .add-expense-container{margin-bottom:20px;display:flex;gap:10px;}
.add-project-container input, .add-expense-container input, .add-expense-container select{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc;}
.add-project-container button, .add-expense-container button{padding:10px 15px;border:none;border-radius:8px;background:#007BFF;color:#fff;cursor:pointer;}
.add-project-container button:hover, .add-expense-container button:hover{transform:scale(1.03);}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{padding:10px;border-bottom:1px solid #ddd;text-align:left;}
th{background:#f5f5f5;color:#007BFF;}
</style>
</head>
<body>

<!-- Slider fond d'écran -->
<div class="slider">
    <div class="slide"></div>
    <div class="slide"></div>
    <div class="slide"></div>
</div>

<!-- Connexion -->
<div class="login-container" id="loginContainer">
    <h1>Suivi Construction Pro</h1>
    <input type="text" id="username" placeholder="Nom d'utilisateur">
    <input type="password" id="password" placeholder="Mot de passe">
    <button onclick="login()">Se connecter</button>
</div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
    <div class="header">
        <h2>Mes Projets</h2>
        <div>
            <button onclick="logout()">Déconnexion</button>
        </div>
    </div>
    <div class="add-project-container">
        <input type="text" id="projectName" placeholder="Nom du projet">
        <button onclick="addProject()">Ajouter projet</button>
    </div>
    <div class="projects-list" id="projectsList"></div>
</div>

<script>
/* ===== Connexion ADMIN simple ===== */
function login(){
    const user=document.getElementById('username').value;
    const pass=document.getElementById('password').value;
    if(user==='ADMIN' && pass==='0990'){
        document.getElementById('loginContainer').style.display='none';
        document.getElementById('dashboard').style.display='block';
        fetchProjects();
    } else {
        alert('Identifiant ou mot de passe incorrect');
    }
}
function logout(){
    document.getElementById('loginContainer').style.display='block';
    document.getElementById('dashboard').style.display='none';
}

/* ===== Firebase config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDHkaPEbLdn_mjfl0bgA0O1tYNY24eXloQ",
  authDomain: "construction-immo.firebaseapp.com",
  projectId: "construction-immo",
  storageBucket: "construction-immo.firebasestorage.app",
  messagingSenderId: "777078993135",
  appId: "1:777078993135:web:f308549b752a3ab4ab2b1a"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

/* ===== Projets ===== */
function addProject(){
    const name=document.getElementById('projectName').value.trim();
    if(name===''){alert('Veuillez saisir un nom de projet');return;}
    db.collection('projets').add({
        nom:name,
        dateCreation:firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{
        document.getElementById('projectName').value='';
        fetchProjects();
    }).catch(err=>console.error(err));
}

function fetchProjects(){
    const list=document.getElementById('projectsList');
    if(!list) return;
    list.innerHTML='';
    db.collection('projets').orderBy('dateCreation','desc').get()
    .then(snapshot=>{
        snapshot.forEach(doc=>{
            const data=doc.data();
            const card=document.createElement('div');
            card.classList.add('project-card');
            card.innerHTML=`
                <span>${data.nom}</span>
                <div>
                    <button onclick="openProject('${doc.id}','${data.nom}')">Voir</button>
                    <button class="delete" onclick="deleteProject('${doc.id}')">Supprimer</button>
                </div>
            `;
            list.appendChild(card);
        });
    });
}

function deleteProject(id){
    if(confirm('Voulez-vous vraiment supprimer ce projet et toutes ses dépenses ?')){
        db.collection('depenses').where('projetId','==',id).get()
        .then(snapshot=>{
            snapshot.forEach(doc=>db.collection('depenses').doc(doc.id).delete());
            db.collection('projets').doc(id).delete().then(fetchProjects);
        });
    }
}

/* ===== Détail projet ===== */
function openProject(id,nom){
    localStorage.setItem('currentProjectId',id);
    localStorage.setItem('currentProjectName',nom);
    showProjectDetail();
}

function showProjectDetail(){
    const dashboard=document.getElementById('dashboard');
    dashboard.innerHTML='';

    const projetId=localStorage.getItem('currentProjectId');
    const projetName=localStorage.getItem('currentProjectName');

    const header=document.createElement('div');
    header.classList.add('header');
    header.innerHTML=`
        <h2>Projet : ${projetName}</h2>
        <div>
            <button onclick="logout()">Déconnexion</button>
            <button onclick="backToDashboard()">← Retour</button>
        </div>
    `;
    dashboard.appendChild(header);

    // Formulaire ajout dépense
    const form=document.createElement('div');
    form.classList.add('add-expense-container');
    form.innerHTML=`
        <select id="expenseStep">
            <option value="">Sélectionner l'étape</option>
            <option value="FONDATION">FONDATION</option>
            <option value="ÉLÉVATION">ÉLÉVATION</option>
            <option value="DALLE">DALLE</option>
            <option value="TOITURE">TOITURE</option>
            <option value="ÉLECTRICITÉ">ÉLECTRICITÉ</option>
            <option value="PLOMBERIE">PLOMBERIE</option>
            <option value="MENUISERIE">MENUISERIE</option>
            <option value="FINITION">FINITION</option>
        </select>
        <input type="text" id="expenseDesc" placeholder="Description">
        <input type="number" id="expenseAmount" placeholder="Montant">
        <button onclick="addExpense()">Ajouter dépense</button>
    `;
    dashboard.appendChild(form);

    // Filtre
    const filterDiv=document.createElement('div');
    filterDiv.style.marginTop='10px';
    filterDiv.innerHTML=`
        <label>Filtrer par étape : </label>
        <select id="filterStep" onchange="fetchExpenses()">
            <option value="">Toutes</option>
            <option value="FONDATION">FONDATION</option>
            <option value="ÉLÉVATION">ÉLÉVATION</option>
            <option value="DALLE">DALLE</option>
            <option value="TOITURE">TOITURE</option>
            <option value="ÉLECTRICITÉ">ÉLECTRICITÉ</option>
            <option value="PLOMBERIE">PLOMBERIE</option>
            <option value="MENUISERIE">MENUISERIE</option>
            <option value="FINITION">FINITION</option>
        </select>
    `;
    dashboard.appendChild(filterDiv);

    // Tableau dépenses
    const tableDiv=document.createElement('div');
    tableDiv.classList.add('expenses-list');
    tableDiv.innerHTML=`<table id="expensesTable"><thead><tr>
        <th>Étape</th><th>Description</th><th>Montant</th><th>Date</th><th>Actions</th>
    </tr></thead><tbody></tbody></table>`;
    dashboard.appendChild(tableDiv);

    // Totaux
    const totalDiv=document.createElement('div');
    totalDiv.id='totalsDiv';
    totalDiv.style.marginTop='15px';
    dashboard.appendChild(totalDiv);

    fetchExpenses();
}

function backToDashboard(){
    localStorage.removeItem('currentProjectId');
    localStorage.removeItem('currentProjectName');
    location.reload();
}

/* ===== Dépenses ===== */
function addExpense(){
    const projetId=localStorage.getItem('currentProjectId');
    const step=document.getElementById('expenseStep').value;
    const desc=document.getElementById('expenseDesc').value.trim();
    const amount=parseFloat(document.getElementById('expenseAmount').value);
    if(!step || !desc || !amount){ alert('Veuillez remplir tous les champs'); return; }
    db.collection('depenses').add({
        projetId:projetId, etape:step, description:desc, montant:amount,
        date:new Date().toISOString()
    }).then(()=>{
        document.getElementById('expenseDesc').value='';
        document.getElementById('expenseAmount').value='';
        fetchExpenses();
    });
}

function editExpense(id,step,desc,amount){
    document.getElementById('expenseStep').value=step;
    document.getElementById('expenseDesc').value=desc;
    document.getElementById('expenseAmount').value=amount;
    const btn=document.querySelector('.add-expense-container button');
    btn.textContent='Mettre à jour';
    btn.onclick=function(){
        db.collection('depenses').doc(id).update({
            etape:document.getElementById('expenseStep').value,
            description:document.getElementById('expenseDesc').value,
            montant:parseFloat(document.getElementById('expenseAmount').value),
            date:new Date().toISOString()
        }).then(()=>{
            btn.textContent='Ajouter dépense';
            btn.onclick=addExpense;
            document.getElementById('expenseDesc').value='';
            document.getElementById('expenseAmount').value='';
            fetchExpenses();
        });
    }
}

function deleteExpense(id){
    if(confirm('Voulez-vous vraiment supprimer cette dépense ?')){
        db.collection('depenses').doc(id).delete().then(fetchExpenses);
    }
}

function fetchExpenses(){
    const projetId=localStorage.getItem('currentProjectId');
    const filterStep=document.getElementById('filterStep').value;
    const tbody=document.querySelector('#expensesTable tbody');
    tbody.innerHTML='';
    let query=db.collection('depenses').where('projetId','==',projetId).orderBy('date','desc');
    if(filterStep) query=query.where('etape','==',filterStep);
    query.get().then(snapshot=>{
        const totals={}; let totalGeneral=0;
        snapshot.forEach(doc=>{
            const data=doc.data();
            const tr=document.createElement('tr');
            const date=new Date(data.date).toLocaleDateString('fr-FR');
            tr.innerHTML=`
                <td>${data.etape}</td>
                <td>${data.description}</td>
                <td>${data.montant.toLocaleString()} FCFA</td>
                <td>${date}</td>
                <td>
                    <button onclick="editExpense('${doc.id}','${data.etape}','${data.description}',${data.montant})">✏</button>
                    <button style="background:red;color:#fff;" onclick="deleteExpense('${doc.id}')">❌</button>
                </td>
            `;
            tbody.appendChild(tr);
            totals[data.etape]=(totals[data.etape]||0)+data.montant;
            totalGeneral+=data.montant;
        });
        const totalDiv=document.getElementById('totalsDiv');
        totalDiv.innerHTML='<h3>Totaux par étape :</h3>';
        for(const etape in totals){totalDiv.innerHTML+=`<p><strong>${etape}</strong> : ${totals[etape].toLocaleString()} FCFA</p>`;}
        totalDiv.innerHTML+=`<h3>Total général : ${totalGeneral.toLocaleString()} FCFA</h3>`;
    });
}
</script>
</body>
</html>